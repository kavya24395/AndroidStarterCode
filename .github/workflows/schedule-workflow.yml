name: Schedule PR Merge

on:
  issue_comment:
    types: [created]
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  process-schedule-command:
    if: github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        startsWith(github.event.comment.body, '/schedule')
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
      issues: write

    steps:
      - name: Parse schedule command
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            const match = comment.match(/\/schedule\s+(\d{2}-\d{2}-\d{4})\s+(\d{1,2}):(\d{2})/);

            if (!match) {
              core.setFailed('Use: /schedule DD-MM-YYYY HH:MM (CET)');
              return;
            }

            const [_, date, h, m] = match;
            const [day, month, year] = date.split('-').map(Number);

            const hour = Number(h);
            const minute = Number(m);

            const cetOffset = 1; // January = CET
            const scheduleDate = new Date(Date.UTC(
              year,
              month - 1,
              day,
              hour - cetOffset,
              minute,
              0
            ));

            if (scheduleDate <= new Date()) {
              core.setFailed('Schedule must be in the future');
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `✅ **Scheduled merge:** ${scheduleDate.toUTCString()}\n\n<!-- SCHEDULE_DATA:${scheduleDate.toISOString()} -->`
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['scheduled-merge']
            });

  cancel-schedule-command:
    if: github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        startsWith(github.event.comment.body, '/cancel-schedule')
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Cancel scheduled merge
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'scheduled-merge'
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '❌ Scheduled merge cancelled.'
            });

  check-scheduled-merges:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
      issues: write

    steps:
      - name: Find and merge scheduled PRs
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date();

            const prs = await github.paginate(
              github.rest.pulls.list,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open'
              }
            );

            for (const pr of prs) {
              if (!pr.labels.some(l => l.name === 'scheduled-merge')) continue;

              const comments = await github.paginate(
                github.rest.issues.listComments,
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number
                }
              );

              const scheduleComment = comments
                .filter(c => c.body.includes('<!-- SCHEDULE_DATA:'))
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];

              if (!scheduleComment) continue;

              const match = scheduleComment.body.match(/<!-- SCHEDULE_DATA:(.+?) -->/);
              if (!match) continue;

              const scheduleTime = new Date(match[1]);

              if (now < scheduleTime) continue;

              const { data: prDetails } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });

              if (prDetails.mergeable === false) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: '❌ Scheduled merge failed: merge conflicts.'
                });
                continue;
              }

              if (prDetails.mergeable === null) {
                console.log(`PR #${pr.number} mergeable unknown, retrying`);
                continue;
              }

              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: 'merge'
              });

              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                name: 'scheduled-merge'
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: '✅ PR merged automatically as scheduled.'
              });
            }
